\documentclass[11pt]{article}
\usepackage{graphicx,natbib,amsmath}

\setlength{\textheight}{24.5cm}
\setlength{\textwidth}{16.5cm}
\setlength{\topmargin}{-14mm}
\setlength{\evensidemargin}{-2mm}
\setlength{\oddsidemargin}{-2mm}
\setlength{\headsep}{4mm}

\def\nH{n_{\langle\rm H\rangle}}
\def\Vl{V_{\ell}}
\def\Nl{N_{\ell}}
\def\rhod{\rho_{\rm d}}
\def\ek{\epsilon_k}
\def\pdiff#1#2{\frac{\partial #1}{\partial #2}}
\def\rhogr{\rho_{\rm gr}}
\def\Dd{D_{\!d}}

\def\apj{ApJ}
\def\pasp{PASP}
\def\pasj{PASJ}
\def\araa{ARA\&A}
\def\aap{A\&A}
\def\aaps{A\&AS}
\def\apjl{ApJL}
\def\apjs{ApJS}
\def\mnras{MNRAS}
\def\aj{AJ}
\def\nat{Nature}
\def\icarus{Icarus}
\def\pasa{PASA}

\def\la{\mathrel{\mathchoice {\vcenter{\offinterlineskip\halign{\hfil
$\displaystyle##$\hfil\cr<\cr\sim\cr}}}
{\vcenter{\offinterlineskip\halign{\hfil$\textstyle##$\hfil\cr
<\cr\sim\cr}}}
{\vcenter{\offinterlineskip\halign{\hfil$\scriptstyle##$\hfil\cr
<\cr\sim\cr}}}
{\vcenter{\offinterlineskip\halign{\hfil$\scriptscriptstyle##$\hfil\cr
<\cr\sim\cr}}}}}
\def\ga{\mathrel{\mathchoice {\vcenter{\offinterlineskip\halign{\hfil
$\displaystyle##$\hfil\cr>\cr\sim\cr}}}
{\vcenter{\offinterlineskip\halign{\hfil$\textstyle##$\hfil\cr
>\cr\sim\cr}}}
{\vcenter{\offinterlineskip\halign{\hfil$\scriptstyle##$\hfil\cr
>\cr\sim\cr}}}
{\vcenter{\offinterlineskip\halign{\hfil$\scriptscriptstyle##$\hfil\cr
>\cr\sim\cr}}}}}


\begin{document}

\centerline{Definitions}

\begin{tabular}{l|l|c}
\hline
symbol  & description & unit\\
\hline
$z$                       & vertical coordinate    & cm\\
$\ek$                     & abundance of element $k$ 
                            with respect to H      & --\\
$n_i$                     & particle density of molecule $i$ & cm$^{-3}$\\
$\nH$                     & total hydrogen nuclei density & cm$^{-3}$\\
$\rho = \sum_i n_i m_i = \mu_{\rm H}\,\nH = \mu \sum_i n_i$  
                          & gas mass density       & g\,cm$^{-3}$\\
$m_i$                     & mass of particle $i$   & g\\
$m_k$                     & mass of element $k$    & g\\
$\mu = {\sum_i n_i m_i}\Big/{\sum_i n_i}$ 
                          & mean gas particle mass & g\\
$\mu_{\rm H} = \sum_k \epsilon_k m_k$   
                          & proportionality constant & g\\
$T$                       & gas temperature        & K\\
$p = \frac{\rho}{\mu}kT = \sum_i n_i\,kT$  
                          & gas pressure           & dyn\,cm$^{-2}$\\
$D$                       & diffusion coefficient  & cm$^2$\,s$^{-1}$\\
\hline  
\end{tabular}

\bigskip
\section{The Atmospheric Diffusion Problem}

To simultaneously model the evolution of the chemical composition of
the atmosphere and the crust of a hot rocky planet, we use the
implicit/explicit time-dependent second-order diffusion solver {\sc
  Diffuse} developed by Peter Woitke.  At the top of the atmosphere, a
modified fixed-flux boundary condition will be applied to allow for
the Jeans escape of H$_2$ and He (see Sect.~\ref{UpperBound}), whereas
at the bottom, a modified fixed-concentration boundary condition will
be applied to treat the outgasing/deposition of elements from/to the
crust (see Sect.~\ref{LowerBound}). By book-keeping the element fluxed
through the lower boundary, we can also predict how the crust
composition changes with time.
 
In the planet atmosphere between these boundaries, we solve the 
second-order diffusion problem
\begin{equation}
  \pdiff{(\nH\,\ek)}{t} + \nabla(\vec{v}\,\nH\ek) 
   ~=~ \nabla\left(\nH D\,\nabla\ek\right) \ .
\end{equation}
Assuming a 1-d plane-parallel and static $(\vec{v}=0)$ atmosphere, the
equations to solve are
\begin{equation}
  \frac{d}{dt}\Big(\nH\,\ek\Big) 
  ~=~ \frac{d}{dz}\left(\nH D\,\frac{d\ek}{dz}\right) \ .
  \label{eq:diff1}
\end{equation}
Assuming, in addition, a constant density structure
$\nH=\nH\!(z)$ the equations simplify to
\begin{equation}
  \frac{d\ek}{dt} 
  ~=~ \frac{1}{\nH}\,\frac{d}{dz}\!\left(\nH D\,\frac{d\ek}{dz}\right) \ ,
  \label{eq:diff2}
\end{equation}
where $\ek(z,t)$ are the height-dependent and time-dependent element
abundances in the planet atmosphere we wish to determine. We note that
$\nH=\nH\!(z)$ and $D=D(z)$ vary by many orders of magnitude
throughout the atmosphere, often more than the element abundances we
wish to determine, therefore we {\sl cannot} neglect the
$\frac{d\nH}{dz}$ and $\frac{dD}{dz}$ terms as
\begin{equation}
  \frac{d\ek}{dt} ~\neq~ D\,\frac{d^{\,2}\ek}{dz^2} \ .
\end{equation}
The diffusion constant $D(z)$ is determined by (i) the microscopic diffusion
which turns out to be important in the uppermost layers $D_{\rm
  micro}$, and (ii) the turbulent quasi-diffusion $D_{\rm mix}$ due to 
vertical mixing processes excited e.g.\ by convective or other flow 
instabilities. 
\begin{equation}
  D(z) = D_{\rm micro}(z) + D_{\rm mix}(z)
\end{equation}
Since the turbulent diffusion takes place on large spatial scales, we
can safely assume that $D_{\rm mix}$ does not depend on the molecule
(or element) we want to diffuse. Concerning $D_{\rm micro}$, however, 
there is a small dependence on the size and reduced mass of the
molecule with respect to collisions with H$_2$, see
\citet[][Eq.~(26) therein]{Woitke2003}, which causes deviations
of $D$ as function of molecule by a factor of about 2 to 3. We will simply
neglect these deviations in the following.

This neglection allows us to calculate the diffusion of elements
rather than the diffusion of individual molecules.
The total particle density $\rm[cm^{-3}]$ of element $k$ is given by 
\begin{equation}
  \nH\,\ek = \sum_i s_{i,k}\,n_i
\end{equation} 
where $s_{i,k}$ is the stoichiometic factor of element $k$ in molecule
$i$, for example $s_{\rm H_2O,H}=2$. Using Eq.~(\ref{eq:diff1}), the
diffusion of that total nuclei particle density is given by
\begin{eqnarray}
  \frac{d}{dt}\left(\nH\,\ek\right)
  &=& \frac{d}{dt}\sum_i s_{i,k}\,n_i
  ~=~ \sum_i s_{i,k}\,\frac{dn_i}{dt} \\
  &=& \sum_i s_{i,k}\,\frac{d}{dz}\!\left(\nH D\,\frac{d}{dz}
                     \left(\frac{n_i}{\nH}\right)\right) \\
  &=& \frac{d}{dz}\!\left(\nH D\,\frac{d}{dz}\left(\sum_i s_{i,k}
  \frac{n_i}{\nH}\right)\right) \\
  &=& \frac{d}{dz}\!\left(\nH D\,\frac{d\ek}{dz}\right)
\end{eqnarray}




\section{Spatial Grid and Initial Conditions}
\label{sec:init}

We use an equidistant grid in $\{z_i\,|\,i\!=\!0,...,I\}$ to
discretise the 1d-structure of the planetary atmosphere with fixed
temperature and pressure points in hydrostatic equilibrium, $T_i=T(z_i)$
and $p_i=p(z_i)$.  At the lower boundary $(z_0=0)$ of the model, the
atmospheric gas is in physical contact with the crust. The crust is
represented by column densities $N_j^{\rm cond}$ for a number of
$j=1,...,J$ condensed species.

At initialisation $(t=0)$, we consider a set of total (gas plus
condensed) element abundances $\{\epsilon_k^0\}$ at temperature
$T_0$ and pressure $p_0$ in phase equilibrium, using the {\sc
  GGchem}-code \citep{Woitke2017}.  The total element abundances
$\{\epsilon_k^0\}$ are chosen from one of the sets listed in
Table~\ref{tab:eps}. The results of this phase equilibrium 
computation are
\begin{itemize}
\itemsep=-1pt
\parsep=0pt
  \item the identification of kind and number $J$ of simultaneously present 
        condensates
  \item the volume density of units of those condensates
        $n_j^{\rm cond}\ (j=1,...,J)\ \rm[cm^{-3}]$,
  \item the remaining element abundances $\{\epsilon_k^{\rm gas}\}$ in the gas
        phase above the condensates
\end{itemize}
We define the condensed element abundances as
\begin{equation}
  \nH\,\epsilon_k^{\rm cond} = \sum_{j=1}^J s_{j,k}\,n_j^{\rm cond}
\end{equation}
where $s_{j,k}$ is the stoichiometric factor of element $k$ in
condensate $j$, for example $s_{\rm Al_2O_3,O}=3$. The element
conservation is then given by
\begin{equation}
  \epsilon_k^0 = \epsilon_k^{\rm gas} + \epsilon_k^{\rm cond} \ .
\end{equation}
At initialisation, we fill the lowest atmospheric cell with element
composition $\epsilon_k^{\rm gas}$, and use the identification and
ratio of condensed species in phase equilibrium with that gas to
initialise the crust. At given pressure, there is a free constant in
phase equilibrium, namely the total amount of condensates. We can add
an arbitrary amount of the mixture of condensates as
\begin{equation}
  \widetilde{\epsilon}_k^{\;0} = \epsilon_k^{\rm gas} 
                           + X\,\epsilon_k^{\rm cond} \ .
\end{equation}
and re-run the phase equilibrium computation at the same pressure
and temperature, but now with $\{\widetilde\epsilon_k^{\;0}\}$ instead of
$\{\epsilon_k^0\}$ -- all resulting gas properties including $\epsilon_k^{\rm
  gas}$ will stay the same.  This property of phase equilibrium allows us
to consider the ``thickness of the active crust'' $D$ as a free 
parameter. The initial column densities in the active crust are
given by
\begin{equation}
  N_j^{\rm cond} = D\,n_j^{\rm cond}
\end{equation}
All atmospheric cells above the bottom cell $(i=1,...,I)$ are finally
filled with a gas of solar abundances, or any other chosen set 
of element abundances.

\begin{table}
\centering
\caption{Different sets of element abundances normalised to hydrogen
  (need citations). $A(-B)$ means $A\times 10^{-B}$.}
\label{tab:eps}
\vspace*{2mm}
\begin{tabular}{cccc}
\hline
     &     solar & Earth crust & meteoritic \\
\hline
 H   & $1.00(+0)$ &   $1.00(+0)$ &   $1.00(+0)$ \\
 He  & $8.51(-2)$ &   $1.08(-6)$ &   -- \\
 Li  & $1.12(-11)$ &  $2.07(-3)$ &   $1.03(-5)$ \\
 C   & $2.69(-4)$ &   $1.20(-2)$ &   $5.25(-2)$ \\
 N   & $6.76(-5)$ &   $9.76(-4)$ &   $4.20(-3)$ \\
 O   & $4.90(-4)$ &   $2.07(+1)$ &   $1.05(+0)$ \\
 Na  & $1.74(-6)$ &   $7.39(-1)$ &   $1.00(-2)$ \\
 Mg  & $3.98(-5)$ &   $6.90(-1)$ &   $2.07(-1)$ \\
 Al  & $2.82(-6)$ &   $2.20(+0)$ &   $1.42(-2)$ \\
 Si  & $3.24(-5)$ &   $7.23(+0)$ &   $2.09(-1)$ \\
 P   & $2.57(-7)$ &   $2.44(-2)$ &   $1.49(-3)$ \\
 S   & $1.32(-5)$ &   $7.86(-3)$ &   $5.24(-2)$ \\
 Cl  & $3.16(-7)$ &   $2.94(-3)$ &   $4.38(-4)$ \\
 K   & $1.07(-7)$ &   $3.85(-1)$ &   $7.52(-4)$ \\
 Ca  & $2.19(-6)$ &   $7.45(-1)$ &   $1.15(-2)$ \\
 Ti  & $8.91(-8)$ &   $8.42(-2)$ &   $4.74(-4)$ \\
 Cr  & $4.37(-7)$ &   $1.41(-3)$ &   $2.42(-3)$ \\
 Mn  & $2.69(-7)$ &   $1.24(-2)$ &   $2.06(-3)$ \\
 Fe  & $3.16(-5)$ &   $7.26(-1)$ &   $1.65(-1)$ \\
 Ni  & $1.66(-6)$ &   $1.03(-3)$ &   $9.30(-3)$ \\
\hline
\end{tabular}
\end{table}


\section{Boundary Conditions}
\subsection{Upper boundary condition}
\label{UpperBound}

We specify the escaping element fluxes from the top of the atmosphere 
by applying the formula for Jeans escape $\to$ \citet{Tian2015} as
upper boundary condition of the model.

\noindent Where to apply that formula? $\to$ exobase $\to$ \citet{Volkov2011}.

\noindent Here, we need to decompose the elements into molecules,
apply the Jeans escape to each molecule, and lump the escaping fluxes
together to get the escaping element fluxes. 

\subsection{Lower boundary condition}
\label{LowerBound}

At the bottom of the atmosphere, the atmospheric gas is in physical contact
with the crust. At pressures of the order of a few tenth of a bar to
several bars, the collision rates of gas particles with the crust are
huge, leading to a fast relaxation towards phase equilibrium.  We will
therefore assume that the gas at the bottom of the atmosphere is
saturated (i.e.\ in phase equilibrium) with respect to the solid/liquid 
materials present in the crust.
\begin{equation}
  S_j(\ek)\Big|_{z=0} ~=~ 1
  \label{phaseEq}
\end{equation}
As shown in Appendix B of \citep{Woitke2017}, the number of
simultaneously present condensates in phase equilibrium $J$ is limited
by the number of elements $K$ contained in them,
\smallskip
\begin{center}
\begin{tabular}{rcl}
  $J$ &$=$& number of condensates in crust $j=1,...,J$\\
  $K$ &$=$& number of condensed elements in crust $k=1,...,J,J+1,...,K$ \\
\end{tabular}
\end{center} 
i.e.\ the number of condensing elements can (and usually will) exceed
the number of condensates in the crust ($K\geq J$). To formulate the
phase equilibrium inner boundary condition for the diffusion
experiment, we would need to solve $J$ equations (Eq.~\ref{phaseEq})
for $K$ elements which, however, is not possible if $K>J$. In order to solve
this problem, we make a case differentiation between ``limiting'' and
``non-limiting'' elements, and use the element stoichiometry of the
consensates in the crust as an additional constraint. Our inner
boundary condition is formulated as follows:
\begin{equation}
\mbox{\begin{tabular}{lcl}
  1) element not affected by condensation &:& zero-flux boundary
                                              condition $j_k=0$,\\
  2) limiting element &:& fixed concentration $\ek$ from
            Eq.~(\ref{phaseEq}),\\
  3) non-limiting element &:& derived element flux $j_k\neq0$  \ .
\end{tabular}}
\label{eq:innerBC}
\end{equation}
In order to compute the fluxes $j_k$ of the non-limiting elements,
we first run the diffusion solver for the limiting elements 
with fixed $\ek$ boundary condition, which results in the fluxes
of the limiting elements through the inner boundary:
\begin{equation}
  \mbox{limiting element $k=1,...,J$:}\quad\quad 
   j_k = -\nH D \frac{d\ek}{dz}\Big|_{z=0} \ .
  \label{eq:diffuflux}
\end{equation}
Next, we reconstruct the changes of the crust column densities
$N_j^{\rm cond}$ from these fluxes by solving the following system of
linear equations
\begin{equation}
  \sum_{j=1}^J s_{j,k} \frac{dN_j^{\rm cond}}{dt} ~=~ j_k \ ,
\end{equation}
which are $J$ equations for $J$ unknowns. Finally, we derive the
non-limiting element fluxes by using the stoichiometry of the 
crust condensates
\begin{equation}
  \mbox{non-limiting element $k=J+1,...,K$:}\quad\quad 
  j_k = \sum_j s_{j,k} \frac{dN_j^{\rm cond}}{dt}
\end{equation}
For example, let's assume we have MgSiO$_3$[s] and Mg$_2$SiO$_4$[s] as
condensates ($J=2$), which are made of elements Mg, Si and O
($K=3$). The least abundant elements in the gas phase will limit the
growth of these condensates, here Mg and Si, whereas there is plenty
of O available, so there is one non-limiting element, namely
O. Applying the condition of phase equilibrium at the bottom of the
atmosphere, we calculate the element abundances $\epsilon_{\rm Mg}$
and $\epsilon_{\rm Si}$ in phase equilibrium over the crust, and use
these values as boundary conditions for the diffusion solver. As a
result, the element fluxes through the inner boundary $j_{\rm Mg}$ and
$j_{\rm Si}$ are determined via Eq.~(\ref{eq:diffuflux}). To calculate
the respective changes of crust column densities, we solve
\begin{equation}
  \left(\begin{array}{cc} 1 & 2 \\ 
                          1 & 1 \end{array}\right)
  \left(\begin{array}{c} dN_{\rm MgSiO_3}^{\rm cond}/dt \\ 
                         dN_{\rm Mg_2SiO_4}^{\rm cond}/dt \end{array}\right)
  = 
  \left(\begin{array}{c} j_{\rm Mg} \\ j_{\rm Si}\end{array}\right)
\end{equation}
for the unknowns $dN_{\rm MgSiO_3}^{\rm cond}/dt$ and $dN_{\rm Mg_2SiO_4}^{\rm
  cond}/dt$. Finally the matching oxygen flux through the inner 
boundary is found from the stoichiometry of the crust condensates as
\begin{equation}
  j_{\rm O} ~=~ 3\, \frac{dN_{\rm MgSiO_3}^{\rm cond}}{dt}
             + 4\, \frac{dN_{\rm Mg_2SiO_4}^{\rm cond}}{dt}
\end{equation}
which, in the last step, is then used as boundary condition to simulate
the diffusion of oxygen in the atmosphere.

This inner phase-equilibrium boundary condition (Eq.~\ref{eq:innerBC}) can
be used to simulate the deposit of new condensates on top of the crust
as well as the outgasing of crust materials into the atmosphere. It can
also be used for mixed cases, where for example one condensate
outgases wheras, at the same time, other condensates grow on top of
the crust.


\subsection{Updating the crust thickness and composition}

The diffusion experiment as described in Sections~(\ref{UpperBound})
and (\ref{LowerBound}) is carried out for a timestep $\Delta t$ during
which the crust column densities $N_j^{\rm cond}$ can slightly change, but we
assume that the number and kind of stable condensates in the crust
does not change during $\Delta t$.  After each time step, however, we
re-examine whether this is still the case.  We first invert and then
redo the procedure as discibed in Sect.~\ref{sec:init}.
 
In the first step, we decompose all condensates in the crust
and all molecules in the lowest atmospheric cell into elements as
\begin{equation}
  N_k = \nH\ek^{\rm gas}*\Delta z + \sum_{j=1}^J s_{j,k}N_j^{\rm cond} \ ,
\end{equation}
where $\Delta z$ is the vertical extent of the lowest atmospheric cell and 
the $N_k$ are the element column densities in crust and lowest cell. We
``load'' all these elements into th

\begin{equation}
  \ek^0 = N_k/N_{\rm H}
\end{equation}


\section{Element Conservation}



\bibliographystyle{chicagon}
\bibliography{references}

\end{document}
